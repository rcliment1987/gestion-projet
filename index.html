<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de Projet | BIMsmarter</title>
    <meta name="description" content="Application de suivi de projet BIMsmarter - Gestion des t√¢ches, calendrier et assistant IA">
    <link rel="icon" href="https://bimsmarter.eu/wp-content/uploads/2024/07/BIM_Smarter_faviconV2.jpg" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ============================
           VARIABLES & RESET
        ============================ */
        :root {
            --bg-main: hsl(222 47% 11%);
            --bg-card: hsl(222 47% 11% / 0.95);
            --bg-card-solid: hsl(215 28% 17%);
            --bg-hover: hsl(215 25% 22%);
            --bg-input: hsl(215 20% 20%);
            
            --accent: hsl(199 89% 48%);
            --accent-light: hsl(199 89% 58%);
            --accent-dark: hsl(199 89% 38%);
            --accent-bg: hsl(199 89% 48% / 0.1);
            --accent-border: hsl(199 89% 48% / 0.2);
            --accent-border-strong: hsl(199 89% 48% / 0.4);
            
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --info: #3b82f6;
            --info-bg: rgba(59, 130, 246, 0.1);
            
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            --border: hsl(215 20% 25%);
            --border-light: hsl(215 20% 30%);
            
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.4);
            
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Inter', sans-serif;
            background-color: var(--bg-main);
            background-image: radial-gradient(circle at 1px 1px, hsl(199 89% 48% / 0.12) 1px, transparent 0);
            background-size: 24px 24px;
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ============================
           LAYOUT
        ============================ */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--accent-border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--accent-border);
        }

        .logo-link {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .logo-link img {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
        }

        .logo-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .logo-text span {
            color: var(--text-primary);
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 4px;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: var(--accent-bg);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-bg);
            color: var(--accent);
            border-color: var(--accent-border);
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .nav-label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent);
            color: var(--bg-main);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--accent-border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-hover);
            border-radius: var(--radius-md);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--accent-border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-hover);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .header-btn:hover {
            background: var(--accent-bg);
            border-color: var(--accent-border-strong);
        }

        .header-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-main);
        }

        .header-btn.primary:hover {
            background: var(--accent-light);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================
           COMPONENTS
        ============================ */
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title-icon {
            color: var(--accent);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-border-strong);
            box-shadow: var(--shadow-md);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .stat-icon.cyan { background: var(--accent-bg); }
        .stat-icon.green { background: var(--success-bg); }
        .stat-icon.yellow { background: var(--warning-bg); }
        .stat-icon.blue { background: var(--info-bg); }

        .stat-change {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
        }

        .stat-change.up {
            background: var(--success-bg);
            color: var(--success);
        }

        .stat-change.down {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Progress Bar */
        .progress-section {
            margin-top: 16px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-hover);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .chart-container {
            height: 250px;
            position: relative;
        }

        /* ============================
           TASKS PAGE
        ============================ */
        .tasks-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-bg);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
        }

        .filter-btn {
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--accent-bg);
            border-color: var(--accent-border);
            color: var(--accent);
        }

        /* Task List */
        .task-list {
            background: var(--bg-card);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .task-list-header {
            display: grid;
            grid-template-columns: 40px 1fr 120px 120px 100px 100px 80px;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .task-item {
            display: grid;
            grid-template-columns: 40px 1fr 120px 120px 100px 100px 80px;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            align-items: center;
            transition: var(--transition);
        }

        .task-item:hover {
            background: var(--bg-hover);
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .task-checkbox:hover {
            border-color: var(--accent);
        }

        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .task-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 0.8rem;
        }

        .task-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .task-name {
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
        }

        .task-name:hover {
            color: var(--accent);
        }

        .task-name.completed {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .task-subtask-count {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .task-category {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .task-category.development { background: var(--info-bg); color: var(--info); }
        .task-category.design { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
        .task-category.meeting { background: var(--warning-bg); color: var(--warning); }
        .task-category.review { background: var(--success-bg); color: var(--success); }
        .task-category.other { background: var(--accent-bg); color: var(--accent); }

        .task-priority {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
        }

        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .priority-dot.high { background: var(--danger); }
        .priority-dot.medium { background: var(--warning); }
        .priority-dot.low { background: var(--success); }

        .task-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .task-date.overdue {
            color: var(--danger);
        }

        .task-status {
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
        }

        .task-status.todo { background: var(--warning-bg); color: var(--warning); }
        .task-status.progress { background: var(--info-bg); color: var(--info); }
        .task-status.done { background: var(--success-bg); color: var(--success); }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .task-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .task-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .task-action-btn.delete:hover {
            background: var(--danger-bg);
            color: var(--danger);
        }

        /* Subtasks */
        .subtask-container {
            grid-column: 1 / -1;
            padding-left: 52px;
            margin-top: -8px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--bg-hover);
            border-radius: var(--radius-sm);
            margin-bottom: 4px;
        }

        .subtask-item:last-child {
            margin-bottom: 0;
        }

        .add-subtask-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 8px;
        }

        .add-subtask-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ============================
           CALENDAR PAGE
        ============================ */
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .calendar-nav-btn:hover {
            background: var(--accent-bg);
            border-color: var(--accent-border);
        }

        .calendar-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 200px;
            text-align: center;
        }

        .calendar-actions {
            display: flex;
            gap: 12px;
        }

        .calendar-grid {
            background: var(--bg-card);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
        }

        .calendar-weekday {
            padding: 14px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day {
            min-height: 100px;
            padding: 8px;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day:hover {
            background: var(--bg-hover);
        }

        .calendar-day.other-month {
            background: var(--bg-main);
        }

        .calendar-day.other-month .day-number {
            color: var(--text-muted);
        }

        .calendar-day.today {
            background: var(--accent-bg);
        }

        .calendar-day.today .day-number {
            background: var(--accent);
            color: var(--bg-main);
        }

        .day-number {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .day-tasks {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .day-task {
            font-size: 0.7rem;
            padding: 3px 6px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .day-task.todo { background: var(--warning-bg); color: var(--warning); }
        .day-task.progress { background: var(--info-bg); color: var(--info); }
        .day-task.done { background: var(--success-bg); color: var(--success); }

        .day-task-more {
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 2px 6px;
        }

        /* Calendar Sync Section */
        .calendar-sync {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .sync-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .sync-btn:hover {
            background: var(--accent-bg);
            border-color: var(--accent-border);
        }

        .sync-btn img {
            width: 20px;
            height: 20px;
        }

        /* ============================
           MODALS
        ============================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card-solid);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-hover);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-bg);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .btn-secondary {
            background: var(--bg-hover);
            border-color: var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-input);
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-main);
        }

        .btn-primary:hover {
            background: var(--accent-light);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* ============================
           CHATBOT
        ============================ */
        .chatbot-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 900;
            transition: var(--transition);
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
        }

        .chatbot-container {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 380px;
            height: 500px;
            background: var(--bg-card-solid);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            display: none;
            flex-direction: column;
            z-index: 900;
            overflow: hidden;
        }

        .chatbot-container.active {
            display: flex;
            animation: chatSlide 0.3s ease;
        }

        @keyframes chatSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chatbot-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
        }

        .chatbot-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chatbot-avatar {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .chatbot-name {
            font-weight: 600;
        }

        .chatbot-status {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            opacity: 0.8;
            transition: var(--transition);
        }

        .chatbot-close:hover {
            opacity: 1;
        }

        .chatbot-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .chat-message.bot {
            background: var(--bg-hover);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-message.user {
            background: var(--accent);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-message.typing {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }

        .chatbot-input {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .chatbot-input input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .chatbot-input input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chatbot-send {
            width: 44px;
            height: 44px;
            background: var(--accent);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .chatbot-send:hover {
            background: var(--accent-light);
        }

        .chatbot-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quick Actions */
        .chat-quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 16px 12px;
        }

        .quick-action {
            padding: 6px 12px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-action:hover {
            background: var(--accent-bg);
            border-color: var(--accent-border);
            color: var(--accent);
        }

        /* ============================
           RESPONSIVE
        ============================ */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: flex;
            }

            .task-list-header,
            .task-item {
                grid-template-columns: 40px 1fr 100px 80px;
            }

            .task-list-header > *:nth-child(3),
            .task-list-header > *:nth-child(4),
            .task-list-header > *:nth-child(5),
            .task-item > *:nth-child(3),
            .task-item > *:nth-child(4),
            .task-item > *:nth-child(5) {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                display: none;
            }

            .calendar-day {
                min-height: 70px;
                padding: 4px;
            }

            .day-number {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }

            .day-tasks {
                display: none;
            }

            .chatbot-container {
                width: calc(100% - 32px);
                right: 16px;
                bottom: 90px;
                height: 60vh;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .content {
                padding: 16px;
            }

            .task-list-header,
            .task-item {
                grid-template-columns: 36px 1fr 70px;
            }

            .task-list-header > *:nth-child(6),
            .task-list-header > *:nth-child(7),
            .task-item > *:nth-child(6),
            .task-item > *:nth-child(7) {
                display: none;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 14px 24px;
            background: var(--bg-card-solid);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastSlide 0.3s ease;
        }

        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }

        @keyframes toastSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Activity List */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-hover);
            border-radius: var(--radius-md);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .activity-icon.task { background: var(--info-bg); }
        .activity-icon.complete { background: var(--success-bg); }
        .activity-icon.create { background: var(--accent-bg); }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="https://bimsmarter.eu" target="_blank" class="logo-link">
                    <img src="https://bimsmarter.eu/wp-content/uploads/2024/07/BIM_Smarter_faviconV2.jpg" alt="BIMsmarter">
                    <span class="logo-text">BIM<span>smarter</span></span>
                </a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Menu Principal</div>
                    <div class="nav-item active" data-page="dashboard">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-label">Dashboard</span>
                    </div>
                    <div class="nav-item" data-page="tasks">
                        <span class="nav-icon">‚úÖ</span>
                        <span class="nav-label">T√¢ches</span>
                        <span class="nav-badge" id="taskBadge">0</span>
                    </div>
                    <div class="nav-item" data-page="calendar">
                        <span class="nav-icon">üìÖ</span>
                        <span class="nav-label">Calendrier</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Synchronisation</div>
                    <div class="nav-item" onclick="exportToICS()">
                        <span class="nav-icon">üì§</span>
                        <span class="nav-label">Exporter iCal</span>
                    </div>
                    <div class="nav-item" onclick="openGoogleCalendar()">
                        <span class="nav-icon">üîó</span>
                        <span class="nav-label">Google Calendar</span>
                    </div>
                    <div class="nav-item" onclick="openOutlookCalendar()">
                        <span class="nav-icon">üìß</span>
                        <span class="nav-label">Outlook</span>
                    </div>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">RC</div>
                    <div class="user-details">
                        <div class="user-name">Renaud C.</div>
                        <div class="user-role">BIM Coordinator</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="exportData()">
                        <span>üì•</span> Exporter
                    </button>
                    <button class="header-btn primary" onclick="openTaskModal()">
                        <span>‚ûï</span> Nouvelle t√¢che
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- Dashboard Page -->
                <div class="page active" id="page-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon cyan">üìã</div>
                                <span class="stat-change up" id="statTotalChange">+0</span>
                            </div>
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-label">Total T√¢ches</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon green">‚úÖ</div>
                            </div>
                            <div class="stat-value" id="statDone">0</div>
                            <div class="stat-label">Termin√©es</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon blue">üîÑ</div>
                            </div>
                            <div class="stat-value" id="statProgress">0</div>
                            <div class="stat-label">En cours</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon yellow">‚è≥</div>
                            </div>
                            <div class="stat-value" id="statTodo">0</div>
                            <div class="stat-label">√Ä faire</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="card-title-icon">üìà</span>
                                Progression Globale
                            </div>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span class="card-title-icon">üéØ</span>
                                    R√©partition par statut
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span class="card-title-icon">üìä</span>
                                    Par priorit√©
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="priorityChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="card-title-icon">‚ö°</span>
                                Activit√© r√©cente
                            </div>
                        </div>
                        <div class="activity-list" id="activityList">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <div class="empty-state-text">Aucune activit√© r√©cente</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tasks Page -->
                <div class="page" id="page-tasks">
                    <div class="tasks-toolbar">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Rechercher une t√¢che..." onkeyup="filterTasks()">
                        </div>
                        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">Toutes</button>
                        <button class="filter-btn" data-filter="todo" onclick="setFilter('todo')">√Ä faire</button>
                        <button class="filter-btn" data-filter="progress" onclick="setFilter('progress')">En cours</button>
                        <button class="filter-btn" data-filter="done" onclick="setFilter('done')">Termin√©es</button>
                    </div>

                    <div class="task-list" id="taskList">
                        <div class="task-list-header">
                            <div></div>
                            <div>T√¢che</div>
                            <div>Cat√©gorie</div>
                            <div>Priorit√©</div>
                            <div>√âch√©ance</div>
                            <div>Statut</div>
                            <div>Actions</div>
                        </div>
                        <div id="taskListBody">
                            <!-- Tasks will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Calendar Page -->
                <div class="page" id="page-calendar">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
                            <h2 class="calendar-title" id="calendarTitle">Janvier 2026</h2>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
                        </div>
                        <div class="calendar-actions">
                            <button class="header-btn" onclick="goToToday()">Aujourd'hui</button>
                            <button class="header-btn primary" onclick="openTaskModal()">‚ûï Ajouter</button>
                        </div>
                    </div>

                    <div class="calendar-grid">
                        <div class="calendar-weekdays">
                            <div class="calendar-weekday">Lun</div>
                            <div class="calendar-weekday">Mar</div>
                            <div class="calendar-weekday">Mer</div>
                            <div class="calendar-weekday">Jeu</div>
                            <div class="calendar-weekday">Ven</div>
                            <div class="calendar-weekday">Sam</div>
                            <div class="calendar-weekday">Dim</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <!-- Calendar days will be rendered here -->
                        </div>
                    </div>

                    <div class="calendar-sync">
                        <button class="sync-btn" onclick="exportToICS()">
                            <span>üìÖ</span> T√©l√©charger .ics
                        </button>
                        <button class="sync-btn" onclick="openGoogleCalendar()">
                            <span>üî¥</span> Google Calendar
                        </button>
                        <button class="sync-btn" onclick="openOutlookCalendar()">
                            <span>üîµ</span> Outlook Calendar
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nouvelle t√¢che</h2>
                <button class="modal-close" onclick="closeTaskModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="taskId">
                <div class="form-group">
                    <label class="form-label">Nom de la t√¢che *</label>
                    <input type="text" class="form-input" id="taskName" placeholder="Ex: R√©vision du mod√®le BIM">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="taskDescription" placeholder="D√©tails de la t√¢che..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cat√©gorie</label>
                        <select class="form-select" id="taskCategory">
                            <option value="development">üíª D√©veloppement</option>
                            <option value="design">üé® Design</option>
                            <option value="meeting">üë• R√©union</option>
                            <option value="review">üîç Revue</option>
                            <option value="other">üìÅ Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priorit√©</label>
                        <select class="form-select" id="taskPriority">
                            <option value="low">üü¢ Basse</option>
                            <option value="medium" selected>üü° Moyenne</option>
                            <option value="high">üî¥ Haute</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date d'√©ch√©ance</label>
                        <input type="date" class="form-input" id="taskDueDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Statut</label>
                        <select class="form-select" id="taskStatus">
                            <option value="todo">√Ä faire</option>
                            <option value="progress">En cours</option>
                            <option value="done">Termin√©</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">T√¢che parente (optionnel)</label>
                    <select class="form-select" id="taskParent">
                        <option value="">-- Aucune (t√¢che principale) --</option>
                        <!-- Parent tasks will be populated here -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTaskModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveTask()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Chatbot -->
    <button class="chatbot-toggle" onclick="toggleChatbot()" title="Assistant IA">ü§ñ</button>
    
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <div class="chatbot-header-info">
                <div class="chatbot-avatar">ü§ñ</div>
                <div>
                    <div class="chatbot-name">BIM Assistant</div>
                    <div class="chatbot-status">Propuls√© par Mistral AI</div>
                </div>
            </div>
            <button class="chatbot-close" onclick="toggleChatbot()">‚úï</button>
        </div>
        <div class="chatbot-messages" id="chatMessages">
            <div class="chat-message bot">
                Bonjour ! üëã Je suis votre assistant BIM. Comment puis-je vous aider avec votre projet aujourd'hui ?
            </div>
        </div>
        <div class="chat-quick-actions">
            <button class="quick-action" onclick="sendQuickMessage('R√©sume mes t√¢ches en cours')">üìã T√¢ches en cours</button>
            <button class="quick-action" onclick="sendQuickMessage('Quelles t√¢ches sont en retard ?')">‚ö†Ô∏è En retard</button>
            <button class="quick-action" onclick="sendQuickMessage('Conseils BIM')">üí° Conseils</button>
        </div>
        <div class="chatbot-input">
            <input type="text" id="chatInput" placeholder="Tapez votre message..." onkeypress="handleChatKeypress(event)">
            <button class="chatbot-send" id="chatSendBtn" onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============================
        // DATA MANAGEMENT
        // ============================
        let tasks = JSON.parse(localStorage.getItem('bimsmarter_tasks')) || [];
        let activities = JSON.parse(localStorage.getItem('bimsmarter_activities')) || [];
        let currentFilter = 'all';
        let currentDate = new Date();
        let statusChart, priorityChart;

        // Save to localStorage
        function saveTasks() {
            localStorage.setItem('bimsmarter_tasks', JSON.stringify(tasks));
        }

        function saveActivities() {
            localStorage.setItem('bimsmarter_activities', JSON.stringify(activities));
        }

        function addActivity(type, text) {
            activities.unshift({
                id: Date.now(),
                type: type,
                text: text,
                time: new Date().toISOString()
            });
            if (activities.length > 20) activities = activities.slice(0, 20);
            saveActivities();
            renderActivities();
        }

        // ============================
        // NAVIGATION
        // ============================
        const navItems = document.querySelectorAll('.nav-item[data-page]');
        const pages = document.querySelectorAll('.page');
        const pageTitle = document.getElementById('pageTitle');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                
                navItems.forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                
                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(`page-${page}`).classList.add('active');
                
                const titles = {
                    'dashboard': 'Dashboard',
                    'tasks': 'T√¢ches',
                    'calendar': 'Calendrier'
                };
                pageTitle.textContent = titles[page];
                
                if (page === 'calendar') renderCalendar();
            });
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // ============================
        // TASKS MANAGEMENT
        // ============================
        function openTaskModal(taskId = null) {
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('modalTitle');
            
            populateParentSelect();
            
            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    title.textContent = 'Modifier la t√¢che';
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskName').value = task.name;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskCategory').value = task.category;
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskDueDate').value = task.dueDate || '';
                    document.getElementById('taskStatus').value = task.status;
                    document.getElementById('taskParent').value = task.parentId || '';
                }
            } else {
                title.textContent = 'Nouvelle t√¢che';
                document.getElementById('taskId').value = '';
                document.getElementById('taskName').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskCategory').value = 'development';
                document.getElementById('taskPriority').value = 'medium';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('taskStatus').value = 'todo';
                document.getElementById('taskParent').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
        }

        function populateParentSelect() {
            const select = document.getElementById('taskParent');
            const currentId = document.getElementById('taskId').value;
            const mainTasks = tasks.filter(t => !t.parentId && t.id != currentId);
            
            select.innerHTML = '<option value="">-- Aucune (t√¢che principale) --</option>';
            mainTasks.forEach(task => {
                select.innerHTML += `<option value="${task.id}">${task.name}</option>`;
            });
        }

        function saveTask() {
            const taskId = document.getElementById('taskId').value;
            const name = document.getElementById('taskName').value.trim();
            
            if (!name) {
                showToast('Veuillez entrer un nom de t√¢che', 'warning');
                return;
            }
            
            const taskData = {
                id: taskId ? parseInt(taskId) : Date.now(),
                name: name,
                description: document.getElementById('taskDescription').value.trim(),
                category: document.getElementById('taskCategory').value,
                priority: document.getElementById('taskPriority').value,
                dueDate: document.getElementById('taskDueDate').value,
                status: document.getElementById('taskStatus').value,
                parentId: document.getElementById('taskParent').value || null,
                createdAt: taskId ? tasks.find(t => t.id == taskId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (taskId) {
                const index = tasks.findIndex(t => t.id == taskId);
                tasks[index] = taskData;
                addActivity('task', `T√¢che modifi√©e: ${name}`);
                showToast('T√¢che mise √† jour !', 'success');
            } else {
                tasks.push(taskData);
                addActivity('create', `Nouvelle t√¢che: ${name}`);
                showToast('T√¢che cr√©√©e !', 'success');
            }
            
            saveTasks();
            renderTasks();
            updateStats();
            closeTaskModal();
        }

        function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (confirm(`Supprimer "${task.name}" ?`)) {
                // Delete subtasks too
                tasks = tasks.filter(t => t.id !== taskId && t.parentId !== taskId);
                saveTasks();
                renderTasks();
                updateStats();
                addActivity('task', `T√¢che supprim√©e: ${task.name}`);
                showToast('T√¢che supprim√©e', 'success');
            }
        }

        function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                if (task.status === 'done') {
                    task.status = 'todo';
                } else {
                    task.status = 'done';
                    addActivity('complete', `T√¢che termin√©e: ${task.name}`);
                }
                task.updatedAt = new Date().toISOString();
                saveTasks();
                renderTasks();
                updateStats();
            }
        }

        function changeTaskStatus(taskId, status) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = status;
                task.updatedAt = new Date().toISOString();
                if (status === 'done') {
                    addActivity('complete', `T√¢che termin√©e: ${task.name}`);
                }
                saveTasks();
                renderTasks();
                updateStats();
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderTasks();
        }

        function filterTasks() {
            renderTasks();
        }

        function renderTasks() {
            const container = document.getElementById('taskListBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Get main tasks (no parent)
            let mainTasks = tasks.filter(t => !t.parentId);
            
            // Apply filters
            if (currentFilter !== 'all') {
                mainTasks = mainTasks.filter(t => t.status === currentFilter);
            }
            
            if (searchTerm) {
                mainTasks = mainTasks.filter(t => 
                    t.name.toLowerCase().includes(searchTerm) ||
                    (t.description && t.description.toLowerCase().includes(searchTerm))
                );
            }
            
            if (mainTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-title">Aucune t√¢che</div>
                        <div class="empty-state-text">Cr√©ez votre premi√®re t√¢che pour commencer</div>
                        <button class="btn btn-primary" onclick="openTaskModal()">‚ûï Nouvelle t√¢che</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = mainTasks.map(task => {
                const subtasks = tasks.filter(t => t.parentId == task.id);
                const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && task.status !== 'done';
                
                const categoryLabels = {
                    'development': 'üíª Dev',
                    'design': 'üé® Design',
                    'meeting': 'üë• R√©union',
                    'review': 'üîç Revue',
                    'other': 'üìÅ Autre'
                };
                
                const priorityLabels = {
                    'high': 'üî¥ Haute',
                    'medium': 'üü° Moyenne',
                    'low': 'üü¢ Basse'
                };
                
                const statusLabels = {
                    'todo': '√Ä faire',
                    'progress': 'En cours',
                    'done': 'Termin√©'
                };
                
                let html = `
                    <div class="task-item">
                        <div class="task-checkbox ${task.status === 'done' ? 'checked' : ''}" onclick="toggleTaskStatus(${task.id})"></div>
                        <div class="task-info">
                            <div class="task-name ${task.status === 'done' ? 'completed' : ''}" onclick="openTaskModal(${task.id})">${task.name}</div>
                            ${subtasks.length > 0 ? `<div class="task-subtask-count">üìé ${subtasks.length} sous-t√¢che(s)</div>` : ''}
                        </div>
                        <div><span class="task-category ${task.category}">${categoryLabels[task.category]}</span></div>
                        <div class="task-priority">
                            <span class="priority-dot ${task.priority}"></span>
                            ${priorityLabels[task.priority]}
                        </div>
                        <div class="task-date ${isOverdue ? 'overdue' : ''}">${task.dueDate ? formatDate(task.dueDate) : '-'}</div>
                        <div>
                            <select class="task-status ${task.status}" onchange="changeTaskStatus(${task.id}, this.value)" style="background:transparent;border:none;color:inherit;font-size:0.75rem;cursor:pointer;">
                                <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>√Ä faire</option>
                                <option value="progress" ${task.status === 'progress' ? 'selected' : ''}>En cours</option>
                                <option value="done" ${task.status === 'done' ? 'selected' : ''}>Termin√©</option>
                            </select>
                        </div>
                        <div class="task-actions">
                            <button class="task-action-btn" onclick="openTaskModal(${task.id})" title="Modifier">‚úèÔ∏è</button>
                            <button class="task-action-btn delete" onclick="deleteTask(${task.id})" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                
                // Render subtasks
                if (subtasks.length > 0) {
                    html += `<div class="subtask-container">`;
                    subtasks.forEach(sub => {
                        html += `
                            <div class="subtask-item">
                                <div class="task-checkbox ${sub.status === 'done' ? 'checked' : ''}" onclick="toggleTaskStatus(${sub.id})" style="width:18px;height:18px;"></div>
                                <span class="task-name ${sub.status === 'done' ? 'completed' : ''}" style="flex:1;font-size:0.85rem;" onclick="openTaskModal(${sub.id})">${sub.name}</span>
                                <span class="task-status ${sub.status}" style="font-size:0.7rem;padding:2px 8px;">${statusLabels[sub.status]}</span>
                                <button class="task-action-btn delete" onclick="deleteTask(${sub.id})" style="width:28px;height:28px;">üóëÔ∏è</button>
                            </div>
                        `;
                    });
                    html += `
                        <button class="add-subtask-btn" onclick="openSubtaskModal(${task.id})">‚ûï Ajouter une sous-t√¢che</button>
                    </div>`;
                }
                
                return html;
            }).join('');
            
            // Update badge
            document.getElementById('taskBadge').textContent = tasks.filter(t => t.status !== 'done').length;
        }

        function openSubtaskModal(parentId) {
            openTaskModal();
            document.getElementById('taskParent').value = parentId;
        }

        // ============================
        // STATISTICS
        // ============================
        function updateStats() {
            const total = tasks.length;
            const done = tasks.filter(t => t.status === 'done').length;
            const progress = tasks.filter(t => t.status === 'progress').length;
            const todo = tasks.filter(t => t.status === 'todo').length;
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statDone').textContent = done;
            document.getElementById('statProgress').textContent = progress;
            document.getElementById('statTodo').textContent = todo;
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('taskBadge').textContent = todo + progress;
            
            updateCharts(done, progress, todo);
        }

        function initCharts() {
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Termin√©', 'En cours', '√Ä faire'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'],
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 20, usePointStyle: true }
                        }
                    }
                }
            });

            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            priorityChart = new Chart(priorityCtx, {
                type: 'bar',
                data: {
                    labels: ['Haute', 'Moyenne', 'Basse'],
                    datasets: [{
                        label: 'T√¢ches',
                        data: [0, 0, 0],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        },
                        y: {
                            ticks: { color: '#94a3b8', stepSize: 1 },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function updateCharts(done, progress, todo) {
            if (statusChart) {
                statusChart.data.datasets[0].data = [done, progress, todo];
                statusChart.update();
            }
            
            if (priorityChart) {
                const high = tasks.filter(t => t.priority === 'high').length;
                const medium = tasks.filter(t => t.priority === 'medium').length;
                const low = tasks.filter(t => t.priority === 'low').length;
                priorityChart.data.datasets[0].data = [high, medium, low];
                priorityChart.update();
            }
        }

        // ============================
        // ACTIVITIES
        // ============================
        function renderActivities() {
            const container = document.getElementById('activityList');
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-text">Aucune activit√© r√©cente</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activities.slice(0, 5).map(activity => {
                const icons = {
                    'task': 'üìã',
                    'complete': '‚úÖ',
                    'create': '‚ûï'
                };
                
                return `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.type}">${icons[activity.type] || 'üìå'}</div>
                        <div class="activity-content">
                            <div class="activity-text">${activity.text}</div>
                            <div class="activity-time">${formatTimeAgo(activity.time)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================
        // CALENDAR
        // ============================
        const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

        function renderCalendar() {
            const container = document.getElementById('calendarDays');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;
            
            const today = new Date();
            let html = '';
            
            // Previous month days
            const prevMonth = new Date(year, month, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                const dayTasks = tasks.filter(t => t.dueDate === formatDateISO(date));
                
                let tasksHtml = '';
                if (dayTasks.length > 0) {
                    tasksHtml = '<div class="day-tasks">';
                    dayTasks.slice(0, 3).forEach(t => {
                        tasksHtml += `<div class="day-task ${t.status}" title="${t.name}">${t.name}</div>`;
                    });
                    if (dayTasks.length > 3) {
                        tasksHtml += `<div class="day-task-more">+${dayTasks.length - 3} autres</div>`;
                    }
                    tasksHtml += '</div>';
                }
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" onclick="selectDate('${formatDateISO(date)}')">
                        <div class="day-number">${day}</div>
                        ${tasksHtml}
                    </div>
                `;
            }
            
            // Next month days
            const totalCells = Math.ceil((startDay + lastDay.getDate()) / 7) * 7;
            const remaining = totalCells - (startDay + lastDay.getDate());
            for (let day = 1; day <= remaining; day++) {
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }
            
            container.innerHTML = html;
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        function selectDate(dateStr) {
            openTaskModal();
            document.getElementById('taskDueDate').value = dateStr;
        }

        // ============================
        // CALENDAR SYNC
        // ============================
        function exportToICS() {
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//BIMsmarter//Suivi Projet//FR
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;
            
            tasks.forEach(task => {
                if (task.dueDate) {
                    const date = task.dueDate.replace(/-/g, '');
                    icsContent += `BEGIN:VEVENT
UID:${task.id}@bimsmarter.eu
DTSTAMP:${formatICSDate(new Date())}
DTSTART;VALUE=DATE:${date}
DTEND;VALUE=DATE:${date}
SUMMARY:${task.name}
DESCRIPTION:${task.description || ''}
STATUS:${task.status === 'done' ? 'COMPLETED' : 'NEEDS-ACTION'}
END:VEVENT
`;
                }
            });
            
            icsContent += 'END:VCALENDAR';
            
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bimsmarter_tasks.ics';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Fichier iCal t√©l√©charg√© !', 'success');
        }

        function openGoogleCalendar() {
            const task = tasks.find(t => t.dueDate && t.status !== 'done');
            if (task) {
                const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(task.name)}&dates=${task.dueDate.replace(/-/g, '')}/${task.dueDate.replace(/-/g, '')}&details=${encodeURIComponent(task.description || '')}`;
                window.open(url, '_blank');
            } else {
                window.open('https://calendar.google.com', '_blank');
            }
        }

        function openOutlookCalendar() {
            const task = tasks.find(t => t.dueDate && t.status !== 'done');
            if (task) {
                const url = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(task.name)}&startdt=${task.dueDate}&body=${encodeURIComponent(task.description || '')}`;
                window.open(url, '_blank');
            } else {
                window.open('https://outlook.live.com/calendar', '_blank');
            }
        }

        // ============================
        // CHATBOT
        // ============================
        const MISTRAL_API_KEY = '3T3OxFwRPg20i9OfHQjbjwizuSKw57dX';
        let chatHistory = [];

        function toggleChatbot() {
            document.getElementById('chatbotContainer').classList.toggle('active');
        }

        function sendQuickMessage(message) {
            document.getElementById('chatInput').value = message;
            sendChatMessage();
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message bot typing';
            typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            document.getElementById('chatMessages').appendChild(typingDiv);
            scrollChatToBottom();
            
            // Prepare context
            const tasksSummary = getTasksSummary();
            
            try {
                const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MISTRAL_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'mistral-small-latest',
                        messages: [
                            {
                                role: 'system',
                                content: `Tu es un assistant BIM expert et coach de productivit√©. Tu aides l'utilisateur avec son projet BIM et la gestion de ses t√¢ches. Sois concis, pratique et utilise des emojis. Voici le contexte actuel des t√¢ches:\n\n${tasksSummary}\n\nR√©ponds en fran√ßais.`
                            },
                            ...chatHistory.slice(-6),
                            { role: 'user', content: message }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                typingDiv.remove();
                
                if (response.ok) {
                    const data = await response.json();
                    const botMessage = data.choices[0].message.content;
                    addChatMessage(botMessage, 'bot');
                    chatHistory.push({ role: 'user', content: message });
                    chatHistory.push({ role: 'assistant', content: botMessage });
                } else {
                    addChatMessage('D√©sol√©, je rencontre un probl√®me technique. R√©essayez plus tard. üîß', 'bot');
                }
            } catch (error) {
                typingDiv.remove();
                addChatMessage('Erreur de connexion. V√©rifiez votre connexion internet. üåê', 'bot');
            }
        }

        function addChatMessage(message, type) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `chat-message ${type}`;
            div.textContent = message;
            container.appendChild(div);
            scrollChatToBottom();
        }

        function scrollChatToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        function getTasksSummary() {
            const total = tasks.length;
            const done = tasks.filter(t => t.status === 'done').length;
            const progress = tasks.filter(t => t.status === 'progress').length;
            const todo = tasks.filter(t => t.status === 'todo').length;
            
            const overdue = tasks.filter(t => t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'done');
            const urgent = tasks.filter(t => t.priority === 'high' && t.status !== 'done');
            
            let summary = `üìä Statistiques: ${total} t√¢ches total (${done} termin√©es, ${progress} en cours, ${todo} √† faire)\n`;
            
            if (overdue.length > 0) {
                summary += `‚ö†Ô∏è En retard: ${overdue.map(t => t.name).join(', ')}\n`;
            }
            
            if (urgent.length > 0) {
                summary += `üî¥ Priorit√© haute: ${urgent.map(t => t.name).join(', ')}\n`;
            }
            
            const inProgress = tasks.filter(t => t.status === 'progress').slice(0, 5);
            if (inProgress.length > 0) {
                summary += `üîÑ En cours: ${inProgress.map(t => t.name).join(', ')}`;
            }
            
            return summary;
        }

        // ============================
        // UTILITIES
        // ============================
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
        }

        function formatDateISO(date) {
            return date.toISOString().split('T')[0];
        }

        function formatICSDate(date) {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return '√Ä l\'instant';
            if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`;
            if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)}h`;
            return `Il y a ${Math.floor(diff / 86400)}j`;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function exportData() {
            const data = {
                tasks: tasks,
                activities: activities,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bimsmarter_export_${formatDateISO(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Donn√©es export√©es !', 'success');
        }

        // ============================
        // INITIALIZATION
        // ============================
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            renderTasks();
            updateStats();
            renderActivities();
            renderCalendar();
            
            // Demo data if empty
            if (tasks.length === 0) {
                tasks = [
                    {
                        id: 1,
                        name: 'R√©vision mod√®le BIM LOD 300',
                        description: 'V√©rifier la conformit√© du mod√®le architectural avec les sp√©cifications LOD 300',
                        category: 'review',
                        priority: 'high',
                        dueDate: formatDateISO(new Date(Date.now() + 86400000 * 2)),
                        status: 'progress',
                        parentId: null,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'Clash detection MEP/Structure',
                        description: 'Ex√©cuter la d√©tection de conflits entre les r√©seaux MEP et la structure',
                        category: 'development',
                        priority: 'high',
                        dueDate: formatDateISO(new Date(Date.now() + 86400000 * 3)),
                        status: 'todo',
                        parentId: null,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        name: 'R√©union coordination BIM',
                        description: 'Point hebdomadaire avec les diff√©rents intervenants',
                        category: 'meeting',
                        priority: 'medium',
                        dueDate: formatDateISO(new Date(Date.now() + 86400000)),
                        status: 'todo',
                        parentId: null,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 4,
                        name: 'Pr√©parer pr√©sentation client',
                        description: '',
                        category: 'other',
                        priority: 'low',
                        dueDate: formatDateISO(new Date(Date.now() + 86400000 * 5)),
                        status: 'todo',
                        parentId: 3,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                saveTasks();
                renderTasks();
                updateStats();
                renderCalendar();
            }
        });

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTaskModal();
            }
        });

        // Close modal on overlay click
        document.getElementById('taskModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeTaskModal();
            }
        });
    </script>
</body>
</html>
